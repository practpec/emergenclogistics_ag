{% extends "layouts/base.html" %}

{% block title %}EmergenLogistics - Sistema Completo{% endblock %}

{% block header %}
{{ super() }}
<!-- Navegación entre módulos -->
<div class="module-nav">
    <button class="btn active" onclick="showModule('mapas')" id="btn-mapas">
        Generador de Mapas
    </button>
    <button class="btn" onclick="showModule('algoritmo')" id="btn-algoritmo">
        Algoritmo Genético
    </button>
</div>
{% endblock %}

{% block content %}
<!-- MÓDULO DE MAPAS -->
<div id="module-mapas" class="module active">
    <div class="controls">
        <div class="error" id="error-message"></div>
        
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label for="estado">Estado:</label>
                <select id="estado" onchange="onEstadoChange()">
                    <option value="">Selecciona un estado...</option>
                    {% for estado in estados %}
                        <option value="{{ estado }}" {% if estado == "Chiapas" %}selected{% endif %}>
                            {{ estado }}
                        </option>
                    {% endfor %}
                </select>
                <small>Estados de la República Mexicana</small>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="municipio">Municipio:</label>
                <select id="municipio" onchange="onMunicipioChange()" disabled>
                    <option value="">Selecciona un municipio...</option>
                </select>
                <small>Municipios del estado seleccionado</small>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="n_nodos">Número de Destinos:</label>
                <input type="number" id="n_nodos" min="1" max="15" value="5">
                <small id="destinos-info">Localidades disponibles: --</small>
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary" id="generar-btn" onclick="generarMapa()" disabled>
                    Generar Rutas
                </button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="map-section">
            <div class="map-container">
                <div id="map"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p><strong>Generando rutas entre localidades...</strong></p>
                    <p style="font-size: 0.9em; margin-top: 5px;">Calculando rutas del mismo municipio</p>
                </div>
            </div>
        </div>

        <div class="routes-panel" id="routes-panel">
            <div class="panel-header">
                <h3 id="panel-title">Rutas entre Localidades</h3>
                <button class="collapse-btn" onclick="togglePanel()">−</button>
            </div>
            
            <div class="panel-content" id="panel-content">
                <div class="no-routes" style="padding: 40px 20px; text-align: center; color: #718096;">
                    <p>Selecciona estado y municipio para generar rutas</p>
                    <small>Las rutas se generarán entre localidades del mismo municipio</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MÓDULO DE ALGORITMO GENÉTICO -->
<div id="module-algoritmo" class="module">
    <div class="controls">
        <h2>Algoritmo Genético con Localidades del Mismo Municipio</h2>
        <div class="info-box">
            <strong>Estado actual:</strong> El algoritmo genético procesará las localidades 
            del mismo municipio para optimizar la distribución de ayuda humanitaria.
        </div>
        
        <div id="ag-summary">
            <h3>Datos del Mapa Base</h3>
            <div id="summary-content">
                <div style="text-align: center; padding: 40px; color: #718096;">
                    <p><strong>No hay datos de mapa disponibles</strong></p>
                    <p>Para usar el algoritmo genético, primero debes generar un mapa con localidades del mismo municipio.</p>
                    <button onclick="showModule('mapas')" class="btn btn-primary">
                        Ir a Generar Mapa
                    </button>
                </div>
            </div>
        </div>
        
        <div id="ag-placeholder" style="background: #1a1a1a; border: 1px solid #333; padding: 30px; border-radius: 8px; text-align: center; margin-top: 20px;">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Algoritmo Genético - Municipios</h3>
            <p style="color: #a0aec0; margin-bottom: 20px;">
                Esta funcionalidad optimizará la distribución entre localidades del mismo municipio:
            </p>
            <ul style="color: #718096; text-align: left; max-width: 600px; margin: 0 auto 20px;">
                <li>Escenarios basados en localidades reales del municipio</li>
                <li>Optimización considerando distancias cortas</li>
                <li>Análisis de población por localidad</li>
                <li>Rutas eficientes dentro del municipio</li>
                <li>Reportes con datos oficiales INEGI</li>
            </ul>
            <button class="btn btn-primary" disabled>
                Próximamente Disponible
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Datos del backend
    const ENTITIES_DATA = {
        tipos_desastre: {{ tipos_desastre|tojson }},
        tipos_vehiculos: {{ tipos_vehiculos|tojson }},
        categorias_insumos: {{ categorias_insumos|tojson }}
    };
    
    // Variables para manejo de estados y municipios
    let estadosCompletos = [];
    let municipiosDisponibles = [];
    let estadoActual = null;
    let municipioActual = null;
    let localidadesDisponibles = 0;
    
    // Hacer datos disponibles globalmente
    window.ENTITIES_DATA = ENTITIES_DATA;
    
    // Funciones específicas para manejo de estados y municipios
    async function onEstadoChange() {
        const selectEstado = document.getElementById('estado');
        const selectMunicipio = document.getElementById('municipio');
        const generarBtn = document.getElementById('generar-btn');
        const destinosInfo = document.getElementById('destinos-info');
        
        // Limpiar municipios
        selectMunicipio.innerHTML = '<option value="">Selecciona un municipio...</option>';
        selectMunicipio.disabled = true;
        generarBtn.disabled = true;
        municipioActual = null;
        localidadesDisponibles = 0;
        destinosInfo.textContent = 'Localidades disponibles: --';
        
        if (selectEstado.value) {
            try {
                // Cargar municipios del estado seleccionado
                const response = await fetch(`/api/municipios/${encodeURIComponent(selectEstado.value)}`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    municipiosDisponibles = data.data;
                    
                    // Llenar select de municipios
                    data.data.forEach(municipio => {
                        const option = document.createElement('option');
                        option.value = municipio.clave_municipio;
                        option.textContent = municipio.nombre_municipio;
                        selectMunicipio.appendChild(option);
                    });
                    
                    selectMunicipio.disabled = false;
                    estadoActual = selectEstado.value;
                    
                } else {
                    alert('No se encontraron municipios para este estado');
                }
                
            } catch (error) {
                console.error('Error cargando municipios:', error);
                alert('Error cargando municipios');
            }
        } else {
            estadoActual = null;
        }
    }
    
    async function onMunicipioChange() {
        const selectMunicipio = document.getElementById('municipio');
        const generarBtn = document.getElementById('generar-btn');
        const destinosInfo = document.getElementById('destinos-info');
        const nNodosInput = document.getElementById('n_nodos');
        
        if (selectMunicipio.value && estadoActual) {
            try {
                municipioActual = selectMunicipio.value;
                
                // Obtener información del nodo inicial para verificar el municipio
                const url = `/api/nodo-inicial/${encodeURIComponent(estadoActual)}/${selectMunicipio.value}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    // Estimar localidades disponibles (número aproximado)
                    // En producción esto debería venir del backend
                    localidadesDisponibles = Math.floor(Math.random() * 10) + 5; // Entre 5-15
                    
                    destinosInfo.textContent = `Localidades disponibles: ~${localidadesDisponibles}`;
                    
                    // Ajustar máximo del input
                    const maxDestinos = Math.min(localidadesDisponibles, 15);
                    nNodosInput.max = maxDestinos;
                    
                    if (parseInt(nNodosInput.value) > maxDestinos) {
                        nNodosInput.value = maxDestinos;
                    }
                    
                    generarBtn.disabled = false;
                    
                } else {
                    alert('Error obteniendo información del municipio: ' + data.message);
                    municipioActual = null;
                    localidadesDisponibles = 0;
                    destinosInfo.textContent = 'Localidades disponibles: --';
                }
                
            } catch (error) {
                console.error('Error obteniendo información del municipio:', error);
                alert('Error obteniendo información del municipio');
                municipioActual = null;
                localidadesDisponibles = 0;
                destinosInfo.textContent = 'Localidades disponibles: --';
            }
        } else {
            generarBtn.disabled = true;
            municipioActual = null;
            localidadesDisponibles = 0;
            destinosInfo.textContent = 'Localidades disponibles: --';
        }
    }
    
    // Función modificada para generar mapa con municipio
    async function generarMapa() {
        // Intentar recuperar el valor si se perdió
        const selectMunicipio = document.getElementById('municipio');
        if (!municipioActual && selectMunicipio.value) {
            municipioActual = selectMunicipio.value;
        }
        
        if (!estadoActual || !municipioActual) {
            alert('Por favor selecciona estado y municipio');
            return;
        }
        
        const nNodos = parseInt(document.getElementById('n_nodos').value);
        const maxPermitido = Math.min(localidadesDisponibles, 15);
        
        if (nNodos < 1 || nNodos > maxPermitido) {
            alert(`El número de destinos debe estar entre 1 y ${maxPermitido}`);
            return;
        }
        
        try {
            // Mostrar loading
            const loading = document.getElementById('loading');
            const genBtn = document.getElementById('generar-btn');
            
            loading.classList.add('show');
            genBtn.disabled = true;
            genBtn.textContent = 'Generando...';
            
            // Limpiar mapa anterior
            if (window.mapManager) {
                mapManager.clearMap();
            }
            
            // Generar rutas usando API client
            const data = await apiClient.generateCompleteRoutes(
                estadoActual, 
                nNodos, 
                municipioActual
            );
            
            if (data) {
                // Actualizar datos en la aplicación
                app.setMapData(data);
                
                // Mostrar resultados en el mapa
                await displayMapResults(data);
                
                // Actualizar panel de rutas
                if (window.uiManager) {
                    uiManager.updateRoutesPanel(data.rutas_data);
                    
                    // Actualizar título del panel
                    const panelTitle = document.getElementById('panel-title');
                    const municipioNombre = municipiosDisponibles.find(m => m.clave_municipio === municipioActual)?.nombre_municipio || 'Municipio';
                    panelTitle.textContent = `${data.rutas_data.length} Destinos - ${municipioNombre}`;
                }
                
                // Ajustar vista del mapa
                if (window.mapManager) {
                    mapManager.fitToRoutes();
                }
                
            } else {
                alert('Error: No se recibieron datos');
            }
            
        } catch (error) {
            console.error('Error generando mapa:', error);
            alert('Error generando mapa: ' + error.message);
        } finally {
            // Ocultar loading
            const loading = document.getElementById('loading');
            const genBtn = document.getElementById('generar-btn');
            
            loading.classList.remove('show');
            genBtn.disabled = false;
            genBtn.textContent = 'Generar Rutas';
        }
    }
    
    function updateAGSummary(mapData) {
        const summaryContent = document.getElementById('summary-content');
        
        if (mapData) {
            let totalRutas = 0;
            let totalLocalidades = 0;
            
            if (mapData.rutas_data) {
                mapData.rutas_data.forEach(destino => {
                    totalRutas += destino.rutas ? destino.rutas.length : 0;
                });
                totalLocalidades = mapData.rutas_data.length;
            }
            
            const municipioInfo = mapData.municipio_info || {};
            
            summaryContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div style="background: #2d3748; padding: 15px; border-radius: 4px; text-align: center;">
                        <span style="display: block; font-size: 0.9rem; color: #a0aec0; margin-bottom: 8px;">Estado</span>
                        <span style="font-size: 1.2rem; font-weight: 600; color: #ffd700;">${mapData.punto_inicio || 'No definido'}</span>
                    </div>
                    <div style="background: #2d3748; padding: 15px; border-radius: 4px; text-align: center;">
                        <span style="display: block; font-size: 0.9rem; color: #a0aec0; margin-bottom: 8px;">Municipio</span>
                        <span style="font-size: 1.2rem; font-weight: 600; color: #ffd700;">${municipioInfo.nombre_municipio || 'No definido'}</span>
                    </div>
                    <div style="background: #2d3748; padding: 15px; border-radius: 4px; text-align: center;">
                        <span style="display: block; font-size: 0.9rem; color: #a0aec0; margin-bottom: 8px;">Destinos</span>
                        <span style="font-size: 1.2rem; font-weight: 600; color: #ffd700;">${totalLocalidades}</span>
                    </div>
                    <div style="background: #2d3748; padding: 15px; border-radius: 4px; text-align: center;">
                        <span style="display: block; font-size: 0.9rem; color: #a0aec0; margin-bottom: 8px;">Rutas</span>
                        <span style="font-size: 1.2rem; font-weight: 600; color: #ffd700;">${totalRutas}</span>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #1a2332; border: 1px solid #3182ce; border-radius: 4px;">
                    <h4 style="color: #63b3ed; margin-bottom: 10px;">Información del Municipio</h4>
                    <div style="color: #a0aec0; font-size: 0.9rem;">
                        ${mapData.nodo_principal ? `
                            <p><strong>Nodo Principal:</strong> ${mapData.nodo_principal.nombre_localidad}</p>
                            <p><strong>Población:</strong> ${mapData.nodo_principal.poblacion ? mapData.nodo_principal.poblacion.toLocaleString() : 'N/A'} habitantes</p>
                        ` : ''}
                        <p><strong>Tipo de análisis:</strong> Localidades del mismo municipio</p>
                        <p><strong>Fuente de datos:</strong> Base de datos oficial INEGI</p>
                    </div>
                </div>
            `;
        }
    }
    
    // Escuchar eventos de datos actualizados
    document.addEventListener('App:data:map-updated', function(event) {
        updateAGSummary(event.detail.data);
    });
    
    // Inicializar con estado por defecto
    document.addEventListener('DOMContentLoaded', function() {
        onEstadoChange();
    });
</script>

{% endblock %}